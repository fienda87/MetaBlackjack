# Railway Deployment Guide

This guide will help you deploy the MetaBlackjack application to Railway.

## üöÄ Quick Start

### Prerequisites
- Railway account (https://railway.app)
- Git repository with your code
- Railway CLI (optional, but recommended)

### Step 1: Create a New Railway Project

1. Go to [Railway](https://railway.app) and sign in
2. Click "New Project" or "Create Project"
3. Select "Deploy from GitHub repo"
4. Choose your repository
5. Railway will automatically detect Next.js and configure the build

### Step 2: Add PostgreSQL Database

**IMPORTANT**: This is required! Without PostgreSQL, the app will fail with "Invalid value undefined for datasource 'db'"

1. In your Railway project, click "New Service"
2. Select "PostgreSQL" from the database options
3. Click "Add PostgreSQL"
4. Railway will automatically:
   - Provision a PostgreSQL database
   - Create a `DATABASE_URL` environment variable
   - Connect it to your app automatically

### Step 3: Add Redis (Optional but Recommended)

For better performance, add Redis for caching:

1. Click "New Service"
2. Select "Redis"
3. Click "Add Redis"
4. Railway will create a `REDIS_URL` environment variable

### Step 4: Configure Environment Variables

Go to your app service ‚Üí Variables tab and add the following:

#### Required Variables:
```bash
# Database (auto-generated by PostgreSQL plugin)
DATABASE_URL=postgresql://postgres:password@host.railway.app:5432/railway

# Redis (auto-generated by Redis plugin if added)
REDIS_URL=redis://host:port

# Blockchain
POLYGON_AMOY_RPC_URL=https://rpc-amoy.polygon.technology

# Backend Security
BACKEND_PRIVATE_KEY=0x... (generate: node -e "console.log('0x' + require('crypto').randomBytes(32).toString('hex'))")
INTERNAL_API_KEY=... (generate: openssl rand -hex 32)

# Next.js Configuration
NODE_ENV=production
NEXT_PUBLIC_APP_URL=https://your-app.railway.app
```

#### Optional Variables:
```bash
# Performance Monitoring
PERFORMANCE_MONITORING=true
PERFORMANCE_ALERTS=true
DB_LOG_QUERIES=false

# Cache Configuration
CACHE_ENABLED=true
CACHE_TTL_USER=300
CACHE_TTL_GAME=60
CACHE_TTL_HISTORY=120

# Connection Pooling
POOL_SIZE=20
POOL_TIMEOUT=30
```

### Step 5: Configure Build Settings

In your app service ‚Üí Settings ‚Üí Build & Deploy:

**Build Command:**
```bash
npm run build
```

**Start Command:**
```bash
npm run start
```

**Root Directory:** Leave as `/` (default)

### Step 6: Deploy

1. Commit and push your changes to GitHub
2. Railway will automatically detect and rebuild
3. Monitor the deployment logs for any errors

## üîß Troubleshooting

### Error: "Invalid value undefined for datasource 'db'"

**Problem**: PostgreSQL is not configured or DATABASE_URL is missing.

**Solution**:
1. Go to your Railway project
2. Click "New Service" ‚Üí "PostgreSQL"
3. Add PostgreSQL service
4. Restart your app deployment
5. DATABASE_URL will be automatically available

### Error: Build succeeds but page data collection fails

**Problem**: Same as above - PostgreSQL not configured.

**Solution**: Follow the steps above to add PostgreSQL.

### Error: "PrismaClientInitializationError"

**Problem**: Cannot connect to the database.

**Solution**:
1. Check that DATABASE_URL is set in Variables tab
2. Verify PostgreSQL service is running (green checkmark)
3. Restart the PostgreSQL service
4. Restart your app service

### Error: "Cannot find module '@prisma/client'"

**Solution**:
1. Add a script in package.json to generate Prisma client:
   ```json
   "scripts": {
     "postinstall": "npx prisma generate"
   }
   ```
2. Commit and push changes
3. Railway will run postinstall during build

### Slow API responses

**Solution**:
1. Add Redis service (see Step 3 above)
2. Set REDIS_URL environment variable
3. Enable caching: `CACHE_ENABLED=true`
4. Restart deployment

## üìä Database Migrations

Railway requires database migrations to be run during deployment. There are two approaches:

### Option 1: Automatic Migrations (Recommended)

Add this to your `package.json`:

```json
{
  "scripts": {
    "postinstall": "npx prisma generate",
    "build": "npx prisma migrate deploy && next build"
  }
}
```

This will:
1. Generate Prisma client
2. Apply pending migrations automatically
3. Build the Next.js app

### Option 2: Manual Migrations via Railway Console

1. Go to your PostgreSQL service
2. Click "Console" tab
3. Run migration command:
   ```bash
   npx prisma migrate deploy
   ```

## üåê Custom Domain

To use a custom domain:

1. Go to your app service ‚Üí Settings ‚Üí Domains
2. Click "Add Domain"
3. Enter your domain (e.g., `blackjack.yourdomain.com`)
4. Configure DNS as instructed by Railway
5. Update `NEXT_PUBLIC_APP_URL` in Variables tab

## üîí Security Best Practices

1. **Never commit `.env` files** to git
2. **Generate unique keys** for `BACKEND_PRIVATE_KEY` and `INTERNAL_API_KEY`
3. **Use Railway's secrets** for sensitive data
4. **Enable SSL** (Railway does this automatically)
5. **Set NODE_ENV=production** to disable debug logging

## üìà Monitoring & Logs

### View Logs
1. Go to your app service
2. Click "Logs" tab
3. Filter by service (app, postgres, redis)

### Metrics
1. Go to "Metrics" tab
2. Monitor CPU, memory, and network usage
3. Set up alerts for resource limits

### Health Checks
- Health endpoint: `https://your-app.railway.app/api/health`
- Should return: `{"status":"ok"}`
- Railway automatically checks this endpoint

## üîÑ Continuous Deployment

Railway automatically deploys when you:
- Push to the configured branch
- Merge a pull request
- Manually trigger a redeploy

To disable auto-deploy:
1. Go to Settings ‚Üí GitHub
2. Toggle "Deploy on push" off

## üí∞ Cost Optimization

1. **Use Railway's Free Tier** during development
2. **Scale down PostgreSQL** when not in use:
   - Go to PostgreSQL service ‚Üí Settings
   - Reduce RAM and CPU allocation
3. **Enable auto-suspension** for dev environments
4. **Monitor resource usage** in Metrics tab

## üìö Additional Resources

- [Railway Documentation](https://docs.railway.app)
- [PostgreSQL on Railway](https://docs.railway.app/reference/postgres)
- [Redis on Railway](https://docs.railway.app/reference/redis)
- [Environment Variables](https://docs.railway.app/reference/variables)
- [Troubleshooting](./TROUBLESHOOTING.md)

## ‚úÖ Pre-Deployment Checklist

Before deploying to production:

- [ ] PostgreSQL service added and running
- [ ] DATABASE_URL automatically configured
- [ ] Redis service added (optional but recommended)
- [ ] REDIS_URL configured if using Redis
- [ ] BACKEND_PRIVATE_KEY generated and set
- [ ] INTERNAL_API_KEY generated and set
- [ ] POLYGON_AMOY_RPC_URL verified
- [ ] NODE_ENV=production
- [ ] NEXT_PUBLIC_APP_URL set to production domain
- [ ] Database migrations tested
- [ ] Health check endpoint accessible
- [ ] Logs showing no errors
- [ ] SSL certificate active (automatic on Railway)

## üÜò Getting Help

If you encounter issues:

1. Check the [Troubleshooting Guide](./TROUBLESHOOTING.md)
2. Review Railway deployment logs
3. Verify environment variables are set
4. Ensure PostgreSQL is running
5. Check that migrations have been applied

---

**Note**: Railway is a great platform for quick deployments. For production, consider setting up proper monitoring, backups, and disaster recovery procedures.
